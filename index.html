<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ley Line Locator</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: sans-serif;
  box-sizing: border-box;
}

#container {
  display: flex;
  flex-direction: row;
  height: 100vh; /* full viewport height */
}

#sidebar {
  width: 320px;
  min-width: 300px;
  padding: 15px;
  background: #fff;
  border-right: 1px solid #ccc;
  overflow-y: auto;
  box-sizing: border-box;
  flex-shrink: 0;
}

#sidebar-content {
  flex-grow: 1;
}

#map {
  flex: 1;          /* map fills remaining space */
  height: 100%;
  position: relative; /* for absolute positioning of the link */
}

#map-footer-link {
  position: absolute;
  bottom: 10px;
  left: 10px;
  background: rgba(255,255,255,0.9);
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 12px;
  color: #000;
  text-decoration: none;
  border: 1px solid #ccc;
  z-index: 10;
}

#map-footer-link:hover {
  background: rgba(255,255,255,1);
}

h2 {
  margin-top: 0;
}

.legend {
  margin-top: 10px;
}

.legend div {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.legend span {
  display: inline-block;
  width: 14px;
  height: 14px;
  margin-right: 6px;
  border-radius: 50%;
  border: 1px solid #333;
}

/* Mobile layout */
@media (max-width: 768px) {
  #container {
    flex-direction: column;   /* sidebar on top, map below */
    height: 100vh;            /* full viewport height */
  }

  #sidebar {
    width: 100%;
    min-width: auto;
    border-right: none;
    border-top: 1px solid #ccc;
    max-height: 40%;          /* sidebar takes at most 40% of screen */
    overflow-y: auto;         /* allow scrolling */
    flex-shrink: 0;
  }

  #map {
    flex: 1;                  /* map fills remaining space */
    min-height: 200px;        /* ensures map is not too small */
  }
}

  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <img src="https://mapsmania.github.io/leylines/logo.png" alt="Ley Line Locator Logo" style="display: block; margin: 0 auto; max-width: 100%; height: auto;">
    <h2>Instructions</h2>
    <p>Click anywhere on the map to find the nearest ley line connecting two ancient sites.</p>
    <h3>Show Data:</h3>
    <label><input type="radio" name="dataset" value="castles" checked> Castles</label><br>
    <label><input type="radio" name="dataset" value="stones"> Ancient Stones</label><br>
    <label><input type="radio" name="dataset" value="both"> Both</label>
    <div class="legend">
        <h3>Legend</h3>
        <div><span style="background:#b00"></span>Castle</div>
        <div><span style="background:#666"></span>Ancient Stone</div>
        <div><span style="background:#0f0"></span>Your Click</div>
    </div>
  </div>
    <div id="map">
  <a href="https://googlemapsmania.blogspot.com/" target="_blank" id="map-footer-link">Maps Mania</a>
</div>

  
</div>

<script>
async function loadGeoJSON(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to load ' + url);
    return await res.json();
  } catch (err) {
    console.error(err);
    return { type: "FeatureCollection", features: [] };
  }
}

function lineFeature(coords) {
  return { type: "Feature", geometry: { type: "LineString", coordinates: coords }, properties: {} };
}

function pointFeature(coord) {
  return { type: "Feature", geometry: { type: "Point", coordinates: coord }, properties: {} };
}

function calculateAngle(p1, p2, p3) {
  const dx21 = p1[0] - p2[0], dy21 = p1[1] - p2[1];
  const dx31 = p1[0] - p3[0], dy31 = p1[1] - p3[1];
  const a2 = dx21 * dx21 + dy21 * dy21, b2 = dx31 * dx31 + dy31 * dy31;
  const ab = dx21 * dx31 + dy21 * dy31;
  if (a2 === 0 || b2 === 0) return 0;
  return Math.acos(ab / Math.sqrt(a2 * b2)) * 180 / Math.PI;
}

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/positron',
  center: [-2.5, 54.5],
  zoom: 5
});

map.on('load', async () => {
  const castles = await loadGeoJSON('https://mapsmania.github.io/leylines/castles.geojson');
  const stones = await loadGeoJSON('https://mapsmania.github.io/leylines/stones.geojson');

  // Ley line source and layer
  map.addSource('ley-line', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
  map.addLayer({ id: 'ley-line-layer', type: 'line', source: 'ley-line', paint: { 'line-color': '#00f', 'line-width': 3 } });

  // Highlight points source and layer
  map.addSource('highlight-points', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
  map.addLayer({
    id: 'highlight-points-layer',
    type: 'circle',
    source: 'highlight-points',
    paint: {
      'circle-radius': 6,
      'circle-color': [
        'match',
        ['get', 'type'],
        'castle', '#b00',
        'stone', '#666',
        'click', '#0f0',
        '#000'
      ],
      'circle-stroke-width': 1,
      'circle-stroke-color': '#fff'
    }
  });

  // Update dataset function
  function getSites(choice) {
    if (choice === 'castles') return castles.features;
    if (choice === 'stones') return stones.features;
    return [...castles.features, ...stones.features];
  }

  let currentChoice = 'castles';
  document.querySelectorAll('input[name="dataset"]').forEach(input => {
    input.addEventListener('change', (e) => currentChoice = e.target.value);
  });

  // Popup on highlight markers
  map.on('click', 'highlight-points-layer', (e) => {
    const feature = e.features[0];
    const coordinates = feature.geometry.coordinates.slice();
    const props = feature.properties;
    let popupContent = '';

    if (props.type === 'castle') {
      popupContent = `<strong>${props.name || "Castle"}</strong>`;
    } else if (props.type === 'stone') {
      popupContent = `<strong>${props.name || "Ancient Stone"}</strong>`;
    } else if (props.type === 'click') {
      popupContent = `<strong>Your Location</strong>`;
    }

    new maplibregl.Popup()
      .setLngLat(coordinates)
      .setHTML(popupContent)
      .addTo(map);
  });

  // Main map click logic
  map.on('click', e => {
    // Check if the click was on a highlight marker; if so, do nothing
    const features = map.queryRenderedFeatures(e.point, { layers: ['highlight-points-layer'] });
    if (features.length > 0) return;

    const clickedPoint = [e.lngLat.lng, e.lngLat.lat];
    const currentFeatures = getSites(currentChoice);
    let bestAngleDiff = Infinity;
    let bestTriplet = null;

    for (let i = 0; i < currentFeatures.length; i++) {
      for (let j = i + 1; j < currentFeatures.length; j++) {
        const site1 = currentFeatures[i];
        const site2 = currentFeatures[j];
        const coords1 = site1.geometry.coordinates;
        const coords2 = site2.geometry.coordinates;

        const candidates = [
          { A: clickedPoint, B: coords1, C: coords2 },
          { A: clickedPoint, B: coords2, C: coords1 },
          { A: coords1, B: clickedPoint, C: coords2 },
          { A: coords2, B: clickedPoint, C: coords1 },
          { A: coords1, B: coords2, C: clickedPoint },
          { A: coords2, B: coords1, C: clickedPoint },
        ];

        for (const cand of candidates) {
          const angle = calculateAngle(cand.C, cand.A, cand.B);
          const diff = Math.abs(180 - angle);
          if (diff < bestAngleDiff) {
            bestAngleDiff = diff;
            bestTriplet = {
              A: cand.A,
              B: cand.B,
              C: cand.C,
              site1: site1,
              site2: site2
            };
          }
        }
      }
    }

    if (bestTriplet) {
      // Draw ley line
      const leyLineGeoJSON = { type: 'FeatureCollection', features: [lineFeature([bestTriplet.A, bestTriplet.C, bestTriplet.B])] };
      map.getSource('ley-line').setData(leyLineGeoJSON);

      // Highlight just the two sites + clicked location
      const pointsGeoJSON = {
        type: 'FeatureCollection',
        features: [
          { ...bestTriplet.site1, properties: { ...bestTriplet.site1.properties, type: bestTriplet.site1.properties.historic } },
          { ...bestTriplet.site2, properties: { ...bestTriplet.site2.properties, type: bestTriplet.site2.properties.historic } },
          { ...pointFeature(clickedPoint), properties: { type: 'click' } }
        ]
      };
      map.getSource('highlight-points').setData(pointsGeoJSON);

      // Update sidebar
      const site1Name = bestTriplet.site1.properties.name || "Site 1";
      const site2Name = bestTriplet.site2.properties.name || "Site 2";
      document.getElementById('sidebar').innerHTML = `
        <h2>Ley Line Found</h2>
        <p>Your location lies on a Ley Line running through <strong>${site1Name}</strong> and <strong>${site2Name}</strong>.</p>
        <p>Ley lines are straight alignments between historical structures, prehistoric sites, and prominent landmarks. The concept was first proposed by Alfred Watkins in the 1920s, who theorized that these lines were ancient trade routes used by early British societies.</p>
        <h3>Show Data:</h3>
        <label><input type="radio" name="dataset" value="castles" ${currentChoice==='castles'?'checked':''}> Castles</label><br>
        <label><input type="radio" name="dataset" value="stones" ${currentChoice==='stones'?'checked':''}> Ancient Stones</label><br>
        <label><input type="radio" name="dataset" value="both" ${currentChoice==='both'?'checked':''}> Both</label>
        <div class="legend">
          <h3>Legend</h3>
          <div><span style="background:#b00"></span>Castle</div>
          <div><span style="background:#666"></span>Ancient Stone</div>
          <div><span style="background:#0f0"></span>Your Click</div>
        </div>
      `;
      // reattach listeners
      document.querySelectorAll('input[name="dataset"]').forEach(input => {
        input.addEventListener('change', (e) => currentChoice = e.target.value);
      });
    }
  });

  // Cursor change on hover
  map.on('mouseenter', 'highlight-points-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'highlight-points-layer', () => { map.getCanvas().style.cursor = ''; });
});
</script>

</body>
</html>
